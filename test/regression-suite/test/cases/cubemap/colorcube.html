<html>
  <head>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1,IE=edge" />

      <script type="text/javascript" src="../../../../x3dom-full_include.js"></script>
  </head>
  
  <body>

    <X3D xmlns='http://www.web3d.org/specifications/x3d-namespace' showStat='false' showLog='true' width="800px" height="600px">
      <Scene DEF='scene'>
        <Viewpoint position="0 0 4"></Viewpoint>
        <Background id='back1' 
            backUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_back.jpg"'
            bottomUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_bottom.jpg"'
            frontUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_front.jpg"' 
            leftUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_left.jpg"'
            rightUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_right.jpg"'
            topUrl='"https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/cubemap/ocean_3_top.jpg"'>
        </Background>
        <!--Background id='back2' 
            backUrl='"./bBK.png"' bottomUrl='"./bDN.png"'
            frontUrl='"./bFR.png"' leftUrl='"./bLF.png"'
            rightUrl='"./bRT.png"' topUrl='"./bUP.png"'>
        </Background-->
        <Group DEF='MIRROR_SCENE'>
          <Transform DEF='circler'>
          <Transform DEF='BoxTrafo' translation='0 0 10'>
            <Shape>
              <Appearance></Appearance>
              <Box></Box>
            </Shape>
          </Transform>
          </Transform>
        </Group>  
        <Transform>
          <Shape DEF='mirrorSphere'>
            <Appearance>
                <Material diffuseColor=".9 .9 .9" specularColor=".5 .5 .5" shininess='10.0'></Material>
                <ComposedCubeMapTexture repeatS="false" repeatT="false">
                    <!--ImageTexture containerField="back" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.jpg"></ImageTexture-->
                    <ImageTexture containerField="bottom" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.png"></ImageTexture>
                    <!--ImageTexture containerField="front" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.jpg"></ImageTexture-->
                    <!--ImageTexture containerField="left" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.gif"></ImageTexture-->
                    <ImageTexture containerField="right" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.gif"></ImageTexture>
                    <ImageTexture containerField="top" url="https://raw.githubusercontent.com/andreasplesch/x3dom/cubemap/test/regression-suite/test/cases/imageFormats/test_image.png"></ImageTexture>
                    <RenderedTexture containerField='front'  update='always' dimensions='256 256 4' DEF='rt'>
                      <!--Shape USE='mirrorSphere' containerField='excludeNodes' ></Shape-->
                      <Background USE='back1' containerField='background' ></Background>
                      <!-- orientation is look to front, then spin by 180 for gl -->
                        <Viewpoint fieldOfView='1.5708' position='0 0 0' orientation='1 0 0 3.141592' containerField='viewpoint' zNear="0.1" zFar="1000" ></Viewpoint>
                      <Group USE='MIRROR_SCENE'></Group>
                      <textureProperties boundaryModeS='CLAMP_TO_EDGE' boundaryModeT='CLAMP_TO_EDGE'
                                   magnificationFilter='LINEAR' minificationFilter='LINEAR_MIPMAP_LINEAR'
                                   generateMipMaps='true' id='texProps'>
                      </textureProperties>
                    </RenderedTexture>
                    <RenderedTexture containerField='back' update='always' dimensions='256 256 4' DEF='rt'>
                      <!--Shape USE='mirrorSphere' containerField='excludeNodes' ></Shape-->
                      <Background USE='back1' containerField='background' ></Background>
                      <Viewpoint fieldOfView='1.5708' osition='0 0 0' orientation='0 0 1 3.141592' containerField='viewpoint' zNear="0.1" zFar="1000" ></Viewpoint>
                      <Group USE='MIRROR_SCENE'></Group>
                      <textureProperties boundaryModeS='CLAMP_TO_EDGE' boundaryModeT='CLAMP_TO_EDGE'
                                   magnificationFilter='LINEAR' minificationFilter='LINEAR_MIPMAP_LINEAR'
                                   generateMipMaps='true' id='texProps'>
                      </textureProperties>
                    </RenderedTexture>
                    <RenderedTexture containerField='left' update='always' dimensions='256 256 4' DEF='rt'>
                      <!--Shape USE='mirrorSphere' containerField='excludeNodes' ></Shape-->
                      <Background USE='back1' containerField='background' ></Background>
                      <Viewpoint fieldOfView='1.5708' position='0 0 0' orientation='0.70710680 0 0.7071068 3.141592' containerField='viewpoint' zNear="0.1" zFar="1000" ></Viewpoint>
                      <Group USE='MIRROR_SCENE'></Group>
                      <textureProperties boundaryModeS='CLAMP_TO_EDGE' boundaryModeT='CLAMP_TO_EDGE'
                                   magnificationFilter='LINEAR' minificationFilter='LINEAR_MIPMAP_LINEAR'
                                   generateMipMaps='true' id='texProps'>
                      </textureProperties>
                    </RenderedTexture-->
                </ComposedCubeMapTexture>
            </Appearance>
            <Sphere solid="false" ></Sphere>
          </Shape>
        </Transform>
        <TimeSensor DEF='TS' cycleInterval="4" loop="true"></TimeSensor>
        <OrientationInterpolator DEF='OI' key='0 0.5 1' keyValue='0 1 0 0, 0 1 0 3.14, 0 1 0 6.28'></OrientationInterpolator>
        <ROUTE fromNode='TS' fromField='fraction_changed' toNode='OI' toField='set_fraction'></ROUTE>
        <ROUTE fromNode='OI' fromField='value_changed' toNode='BoxTrafo' toField='rotation'></ROUTE>
        <ROUTE fromNode='OI' fromField='value_changed' toNode='circler' toField='rotation'></ROUTE>
      </Scene>
    </X3D>
  </body>
  <script>
    /*
    var x3d=document.createElement('X3D');
    x3d.setAttribute('width','256');
    x3d.setAttribute('height','256');
    var scene=document.querySelector('Scene');
    x3d.appendChild(scene.cloneNode(true));
    var vp=x3d.querySelector('viewpoint');
    vp.setAttribute('position','0,0,0'); // center of sphere
    vp.setAttribute('orientation','0,1,0,3.1415'); // look to front
    var mirror = x3d.querySelector('Shape[DEF=mirrorSphere]');
    mirror.parentNode.removeChild(mirror);
    document.onload=function(){
      var objectUrl;
      var cv=x3d.querySelector('canvas');
      var skip=1;
      x3d.runtime.enterFrame=function(){
        if (skip-- !== 0) return;
        skip=10;
        cv.toBlob(function(blob) {
          URL.revokeObjectURL(objectUrl);
          objectUrl = URL.createObjectURL(blob);
          scene.querySelector('ImageTexture[containerField=front]').url = objectUrl;
        });
      };
    };
    document.body.appendChild(x3d);
    */
  </script>
</html>
